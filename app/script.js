// function onLocationFound(e) {
//   var radius = e.accuracy / 1.2;

//   // L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup();

//   L.circle(e.latlng, radius).addTo(map);
// }

// const marker = new maplibregl.Marker()
//   .setLngLat([-82.4195745, 28.0767053])
//   .addTo(map);
let map;
function onLocationError(e) {
  alert(e.message);
}
let lat, long;
function success(position) {
  const latitude = position.coords.latitude;
  const longitude = position.coords.longitude;
  lat = latitude;
  long = longitude;
  console.log(lat, long);
  map = new maplibregl.Map({
    container: "map",
    style:
      "https://api.maptiler.com/maps/streets/style.json?key=XHYvWuwAyYhECnNLOF8Y",
    center: [long, lat],
    zoom: 15,
  });

  setTimeout(() => {
    const route = {
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: [
          [-82.413834, 28.064305],
          [-82.413818, 28.064331],
          [-82.413812, 28.064371],
          [-82.413821, 28.064411],
          [-82.413825, 28.064416],
          [-82.413845, 28.064445],
          [-82.413882, 28.06447],
          [-82.413925, 28.064486],
          [-82.413923, 28.064523],
          [-82.413922, 28.06454],
          [-82.413912, 28.064814],
          [-82.41391, 28.064893],
          [-82.413865, 28.064893],
          [-82.413406, 28.064889],
          [-82.413321, 28.064917],
          [-82.413243, 28.064972],
          [-82.413219, 28.065048],
          [-82.413218, 28.065117],
          [-82.413217, 28.065221],
          [-82.413216, 28.065666],
          [-82.413191, 28.065666],
          [-82.413113, 28.065665],
          [-82.41253, 28.065659],
          [-82.411788, 28.065665],
          [-82.411697, 28.065668],
          [-82.411282, 28.065686],
          [-82.410705, 28.065711],
          [-82.410622, 28.065711],
          [-82.409483, 28.065711],
          [-82.409339, 28.065711],
          [-82.409218, 28.065712],
          [-82.408289, 28.065711],
          [-82.408087, 28.065711],
          [-82.408087, 28.06566],
          [-82.408086, 28.065573],
          [-82.408085, 28.065019],
          [-82.408085, 28.065016],
          [-82.408084, 28.064893],
          [-82.408084, 28.064848],
          [-82.408084, 28.064786],
          [-82.408083, 28.064045],
          [-82.40808, 28.063778],
          [-82.408079, 28.06328],
          [-82.408102, 28.063156],
          [-82.408142, 28.063062],
          [-82.408179, 28.062974],
          [-82.408215, 28.062877],
          [-82.408339, 28.062692],
          [-82.408366, 28.062656],
          [-82.408437, 28.062559],
          [-82.40854, 28.062407],
          [-82.408617, 28.062256],
          [-82.408682, 28.062076],
          [-82.408708, 28.061947],
          [-82.408716, 28.061849],
          [-82.408716, 28.061811],
          [-82.408719, 28.061751],
          [-82.408721, 28.061697],
          [-82.408724, 28.061297],
          [-82.408725, 28.061198],
          [-82.408726, 28.061055],
          [-82.408727, 28.060948],
          [-82.408723, 28.060811],
          [-82.40872, 28.06063],
          [-82.408719, 28.060564],
          [-82.408725, 28.060516],
          [-82.408767, 28.060436],
          [-82.408767, 28.060285],
          [-82.408767, 28.060137],
          [-82.408771, 28.059506],
          [-82.408776, 28.058653],
          [-82.408777, 28.058561],
          [-82.408773, 28.05721],
          [-82.408769, 28.057097],
          [-82.408914, 28.057147],
          [-82.408989, 28.057169],
          [-82.409069, 28.057181],
          [-82.409292, 28.057219],
          [-82.409481, 28.057242],
          [-82.409645, 28.057254],
          [-82.409733, 28.05726],
          [-82.409893, 28.057272],
          [-82.410545, 28.057272],
          [-82.410914, 28.057234],
          [-82.411438, 28.057242],
          [-82.412973, 28.057221],
          [-82.413093, 28.057222],
          [-82.413093, 28.057227],
          [-82.413095, 28.05735],
          [-82.413096, 28.058033],
          [-82.413097, 28.058683],
          [-82.413092, 28.059018],
          [-82.413096, 28.059328],
          [-82.41309, 28.05961],
          [-82.413107, 28.059624],
          [-82.413133, 28.059645],
          [-82.413196, 28.059685],
          [-82.413258, 28.059687],
          [-82.413304, 28.059654],
          [-82.413341, 28.059618],
          [-82.413346, 28.059326],
          [-82.413345, 28.059046],
          [-82.413345, 28.059018],
          [-82.413342, 28.058608],
          [-82.413334, 28.057348],
          [-82.413333, 28.057223],
          [-82.413314, 28.057223],
          [-82.413093, 28.057222],
          [-82.412973, 28.057221],
          [-82.411438, 28.057242],
          [-82.410914, 28.057234],
          [-82.41086, 28.057228],
          [-82.410528, 28.057189],
          [-82.409901, 28.057158],
          [-82.409642, 28.057145],
          [-82.409472, 28.057136],
          [-82.409292, 28.05712],
          [-82.409289, 28.05712],
          [-82.409077, 28.057083],
          [-82.408922, 28.057038],
          [-82.408764, 28.056988],
          [-82.408654, 28.056942],
          [-82.40867, 28.057059],
          [-82.408681, 28.057117],
          [-82.408692, 28.057173],
          [-82.408692, 28.058558],
          [-82.408692, 28.058807],
          [-82.408691, 28.05955],
          [-82.40869, 28.060137],
          [-82.40869, 28.060273],
          [-82.40869, 28.060444],
          [-82.408725, 28.060516],
          [-82.408719, 28.060564],
          [-82.40872, 28.06063],
          [-82.408723, 28.060811],
          [-82.408727, 28.060948],
          [-82.408726, 28.061055],
          [-82.408726, 28.061115],
          [-82.408725, 28.06117],
          [-82.408725, 28.061198],
          [-82.408721, 28.061697],
          [-82.408719, 28.061751],
          [-82.408716, 28.061811],
          [-82.408716, 28.061849],
          [-82.408708, 28.061947],
          [-82.408682, 28.062076],
          [-82.408617, 28.062256],
          [-82.40854, 28.062407],
          [-82.408437, 28.062559],
          [-82.408366, 28.062656],
          [-82.408339, 28.062692],
          [-82.408215, 28.062877],
          [-82.408179, 28.062974],
          [-82.408102, 28.063156],
          [-82.408096, 28.063186],
          [-82.408079, 28.06328],
          [-82.40808, 28.063778],
          [-82.408083, 28.064045],
          [-82.408084, 28.064786],
          [-82.408084, 28.064786],
          [-82.408084, 28.064848],
          [-82.408084, 28.064893],
          [-82.408085, 28.065019],
          [-82.408086, 28.065573],
          [-82.408087, 28.065711],
          [-82.408106, 28.065711],
          [-82.408289, 28.065711],
          [-82.409218, 28.065712],
          [-82.409339, 28.065711],
          [-82.409933, 28.065711],
          [-82.410622, 28.065711],
          [-82.410705, 28.065711],
          [-82.410943, 28.065718],
          [-82.41142, 28.065733],
          [-82.411719, 28.065741],
          [-82.411789, 28.065742],
          [-82.412014, 28.065742],
          [-82.413115, 28.065742],
          [-82.413194, 28.065742],
          [-82.413216, 28.065742],
          [-82.413215, 28.065841],
          [-82.413213, 28.066312],
          [-82.413214, 28.066517],
          [-82.413214, 28.066587],
          [-82.413215, 28.066911],
          [-82.413215, 28.066976],
          [-82.413213, 28.067064],
          [-82.413207, 28.067668],
          [-82.413207, 28.067696],
          [-82.413058, 28.067714],
          [-82.412775, 28.067747],
          [-82.41258, 28.067764],
          [-82.412443, 28.067788],
          [-82.41237, 28.067801],
          [-82.412191, 28.067851],
          [-82.412042, 28.067911],
          [-82.41198, 28.067936],
          [-82.411825, 28.06798],
          [-82.411781, 28.067983],
          [-82.411664, 28.067992],
          [-82.411496, 28.06799],
          [-82.411384, 28.067988],
          [-82.411193, 28.067986],
          [-82.410472, 28.067975],
          [-82.410184, 28.067971],
          [-82.410073, 28.06797],
          [-82.41008, 28.067939],
          [-82.410082, 28.067929],
          [-82.410073, 28.067874],
          [-82.410044, 28.067825],
          [-82.410008, 28.067796],
          [-82.409998, 28.067788],
          [-82.40994, 28.067766],
          [-82.409881, 28.067763],
          [-82.409825, 28.067776],
          [-82.409776, 28.067804],
          [-82.409766, 28.067815],
          [-82.409739, 28.067844],
          [-82.409718, 28.067892],
          [-82.409716, 28.067944],
          [-82.409732, 28.067993],
          [-82.409765, 28.068036],
          [-82.409811, 28.068067],
          [-82.40984, 28.068076],
          [-82.40984, 28.068183],
          [-82.409954, 28.072302],
          [-82.409944, 28.072479],
          [-82.409947, 28.072625],
          [-82.409956, 28.072967],
          [-82.409973, 28.073216],
          [-82.409971, 28.073781],
          [-82.409967, 28.073975],
          [-82.409963, 28.074188],
          [-82.409956, 28.074808],
          [-82.409957, 28.074876],
          [-82.40996, 28.075023],
          [-82.410019, 28.077038],
          [-82.41003, 28.077195],
          [-82.410026, 28.0779],
          [-82.410088, 28.079301],
          [-82.410091, 28.079365],
          [-82.410103, 28.080212],
          [-82.410154, 28.080295],
          [-82.410191, 28.080316],
          [-82.410237, 28.080342],
          [-82.410317, 28.080358],
          [-82.411517, 28.080384],
          [-82.411644, 28.080383],
          [-82.412428, 28.080384],
          [-82.412829, 28.080384],
          [-82.413311, 28.080377],
          [-82.414187, 28.08038],
          [-82.414162, 28.079698],
          [-82.414159, 28.079605],
          [-82.414151, 28.079382],
          [-82.414103, 28.0785],
          [-82.414095, 28.078426],
          [-82.414089, 28.078268],
          [-82.414048, 28.076153],
          [-82.414048, 28.076038],
          [-82.414033, 28.075097],
          [-82.414026, 28.074685],
          [-82.414023, 28.074488],
          [-82.414021, 28.074343],
          [-82.41402, 28.074318],
          [-82.414012, 28.073911],
          [-82.414013, 28.073315],
          [-82.414006, 28.072836],
          [-82.414016, 28.072436],
          [-82.414005, 28.072142],
          [-82.413999, 28.071984],
          [-82.413999, 28.071897],
          [-82.413997, 28.071526],
          [-82.413994, 28.071076],
          [-82.413994, 28.070726],
          [-82.413994, 28.070354],
          [-82.413987, 28.070259],
          [-82.413983, 28.069557],
          [-82.413982, 28.069305],
          [-82.413982, 28.069175],
          [-82.413985, 28.069055],
          [-82.413798, 28.069054],
          [-82.413163, 28.069049],
          [-82.413184, 28.068944],
          [-82.413198, 28.067994],
          [-82.4132, 28.067892],
          [-82.413203, 28.067813],
          [-82.413207, 28.067696],
          [-82.413213, 28.067064],
          [-82.413215, 28.066976],
          [-82.413215, 28.066911],
          [-82.413214, 28.066721],
          [-82.413214, 28.066587],
          [-82.413213, 28.066312],
          [-82.413215, 28.065841],
          [-82.413216, 28.065742],
          [-82.413216, 28.065666],
          [-82.413217, 28.065221],
          [-82.413218, 28.065117],
          [-82.413219, 28.065048],
          [-82.413243, 28.064972],
          [-82.413321, 28.064917],
          [-82.413406, 28.064889],
          [-82.413451, 28.064889],
          [-82.41391, 28.064893],
          [-82.413911, 28.064841],
          [-82.413912, 28.064814],
          [-82.413923, 28.064523],
          [-82.413925, 28.064486],
          [-82.413967, 28.064481],
          [-82.414006, 28.064469],
          [-82.414039, 28.064447],
          [-82.414062, 28.064416],
          [-82.414074, 28.064381],
          [-82.414072, 28.064345],
          [-82.414058, 28.06431],
          [-82.414044, 28.064294],
          [-82.414032, 28.064281],
          [-82.413997, 28.064261],
          [-82.413957, 28.064252],
          [-82.413938, 28.064253],
          [-82.413913, 28.064254],
          [-82.413873, 28.064269],
          [-82.413852, 28.064286],
          [-82.413839, 28.064296],
          [-82.413833, 28.064306],
        ],
      },
    };

    map.addSource("route", {
      type: "geojson",
      data: route,
    });

    map.addLayer({
      id: "route",
      type: "line",
      source: "route",
      layout: {
        "line-join": "round",
        "line-cap": "round",
      },
      paint: {
        "line-color": "#836FFF",
        "line-width": 6,
      },
    });
    console.log("Hellp");
  }, 100);

  new maplibregl.Marker().setLngLat([long, lat]).addTo(map);
}

navigator.geolocation.getCurrentPosition(success);

// Define the deviceId and URL
// Define a global variable
let globalJsonData, purple_lat, purple_long, myMarker; // Define this globally if you need to access it outside of fetchData

setInterval((s) => {
  async function fetchData() {
    const deviceId = 8400636;
    const url = `https://passio3.com/www/mapGetData.php?getBuses=1&deviceId=${deviceId}&wTransloc=1`;

    const data = {
      json: '{"s0":"2343","sA":1}',
    };

    try {
      const response = await fetch(url, {
        method: "POST", // Change to 'GET' if necessary
        headers: {
          "Content-Type": "application/json",
        },
        body: data.json,
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const json = await response.json();
      globalJsonData = json;

      // Wait for 2 seconds before proceeding
      await new Promise((resolve) => setTimeout(resolve, 2000));
      console.log(globalJsonData, "t");
      // Make sure the JSON structure has these properties before trying to access them

      purple_lat = globalJsonData["buses"]["415596"][0].latitude;
      purple_long = globalJsonData["buses"]["415596"][0].longitude;
      try {
        myMarker.remove();
      } catch {
        console.log("1");
      }

      myMarker = new maplibregl.Marker()
        .setLngLat([purple_long, purple_lat])
        .addTo(map);
    } catch (error) {
      console.error("Error:", error);
    }
  }

  fetchData();
}, 5000);
